<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alertas Web360</title>
</head>
<body>
  <!-- El JS se encargar√° de crear toda la interfaz -->
  <script>

    // =============================
// üîê ALERTAS WEB360 - JS PURA
// Solo funciona en navegador con Firebase y Google Forms
// =============================

// ===== CONFIGURACI√ìN (CAMBIA ESTO) =====
const AUTORIZED_EMAILS = [
  "juan.perez@empresa.com",
  "maria.garcia@empresa.com",
  "carlos.rodriguez@empresa.com"
];

const DEFAULT_PASSWORD = "Sales2025";
const GOOGLE_FORM_URL = "https://forms.gle/XXXXXX"; // ‚Üê ¬°CAMBIA ESTE LINK!
const FIREBASE_CONFIG = {
  apiKey: "TU_API_KEY_REAL_AQUI",
  authDomain: "alertasweb360.firebaseapp.com",
  projectId: "alertasweb360",
  storageBucket: "alertasweb360.appspot.com",
  messagingSenderId: "113022119227802677680",
  appId: "1:113022119227802677680:web:abc123def456"
};

// ===== INICIALIZAR FIREBASE =====
(function() {
  const script = document.createElement('script');
  script.src = 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js';
  document.head.appendChild(script);

  const script2 = document.createElement('script');
  script2.src = 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js';
  document.head.appendChild(script2);

  script.onload = script2.onload = () => {
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();

    let currentUserEmail = null;

    // === LOGIN ===
    function showLoginModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        z-index: 9999;
      `;
      modal.innerHTML = `
        <div style="
          background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        ">
          <h2 style="color: #2c3e50; margin-bottom: 1rem;">üîê Iniciar Sesi√≥n</h2>
          <input type="email" id="login-email" placeholder="tu.correo@empresa.com" style="
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px;
          " required>
          <input type="password" id="login-password" placeholder="Contrase√±a (Sales2025)" style="
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px;
          " required>
          <button id="login-btn" style="
            width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 8px 0;
          ">Ingresar</button>
          <button id="cancel-btn" style="
            width: 100%; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer;
          ">Cancelar</button>
          <p id="login-error" style="color: red; margin-top: 10px; font-size: 0.9em; display: none;">‚ùå Correo o contrase√±a inv√°lidos.</p>
        </div>
      `;
      document.body.appendChild(modal);

      const loginBtn = modal.querySelector('#login-btn');
      const cancelBtn = modal.querySelector('#cancel-btn');
      const errorEl = modal.querySelector('#login-error');

      loginBtn.onclick = () => {
        const email = modal.querySelector('#login-email').value.trim().toLowerCase();
        const password = modal.querySelector('#login-password').value.trim();

        if (!email || !password) {
          errorEl.textContent = 'Por favor, ingresa correo y contrase√±a.';
          errorEl.style.display = 'block';
          return;
        }

        if (!AUTORIZED_EMAILS.includes(email)) {
          errorEl.textContent = 'Correo no autorizado.';
          errorEl.style.display = 'block';
          return;
        }

        if (password !== DEFAULT_PASSWORD) {
          errorEl.textContent = 'Contrase√±a incorrecta.';
          errorEl.style.display = 'block';
          return;
        }

        localStorage.setItem('currentUserEmail', email);
        currentUserEmail = email;
        modal.remove();
        initApp();
      };

      cancelBtn.onclick = () => modal.remove();
    }

    // === DESLOGUEAR ===
    function logout() {
      localStorage.removeItem('currentUserEmail');
      currentUserEmail = null;
      document.getElementById('app-container')?.remove();
      showLoginModal();
    }

    // === INICIAR APP ===
    function initApp() {
      if (document.getElementById('app-container')) return;

      const container = document.createElement('div');
      container.id = 'app-container';
      container.style.cssText = `
        max-width: 900px; margin: 40px auto; padding: 20px; font-family: 'Segoe UI', sans-serif;
        background: #f8f9fa; min-height: 100vh;
      `;
      container.innerHTML = `
        <h1 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">üìã Alertas Web360</h1>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">
          Las alertas se env√≠an v√≠a Google Forms. Solo t√∫ puedes enviar.
        </p>
        <div style="text-align: center; margin-bottom: 30px;">
          <button id="send-alert-btn" style="
            padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 8px;
            font-size: 16px; cursor: pointer; transition: background 0.2s;
          ">‚ûï Enviar Nueva Alerta</button>
          <button id="logout-btn" style="
            margin-left: 15px; padding: 10px 16px; background: #e74c3c; color: white; border: none; border-radius: 8px;
            font-size: 14px; cursor: pointer;
          ">üö™ Desloguear</button>
        </div>
        <div id="alerts-container"></div>
        <p id="status" style="text-align: center; color: #7f8c8d; margin-top: 30px; font-size: 0.9em;"></p>
      `;
      document.body.appendChild(container);

      document.getElementById('send-alert-btn').onclick = () => {
        window.open(GOOGLE_FORM_URL, '_blank');
        document.getElementById('status').textContent = 'üì≤ Abriendo formulario... Llena el formulario y presiona "Enviar".';
      };

      document.getElementById('logout-btn').onclick = logout;

      document.getElementById('status').textContent = `‚úÖ Bienvenido/a, ${currentUserEmail}. Recibir√°s solo tus alertas.`;

      // === ESCUCHAR ALERTAS EN TIEMPO REAL ===
      const alertsContainer = document.getElementById('alerts-container');
      const statusEl = document.getElementById('status');

      db.collection("alertas")
        .orderBy("timestamp", "desc")
        .onSnapshot((snapshot) => {
          alertsContainer.innerHTML = '';

          if (snapshot.empty) {
            alertsContainer.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 40px;">No hay alertas a√∫n.</p>';
            return;
          }

          let hasMatchingAlert = false;
          snapshot.forEach((doc) => {
            const data = doc.data();
            const timestamp = new Date(data.timestamp?.seconds * 1000 || data.timestamp).toLocaleString('es-MX');
            const correo = data.correoAgente || 'Sin correo';
            const mensaje = data.alertaTexto || 'Sin mensaje';

            if (currentUserEmail && correo === currentUserEmail) {
              hasMatchingAlert = true;

              const alertDiv = document.createElement('div');
              alertDiv.style.cssText = `
                background: white; padding: 16px; margin-bottom: 16px; border-left: 4px solid #e74c3c;
                border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
              `;
              alertDiv.innerHTML = `
                <div style="margin-bottom: 8px; color: #7f8c8d; font-size: 0.9em;">üìÖ ${timestamp}</div>
                <div style="color: #3498db; font-weight: bold; margin-bottom: 8px;">‚úâÔ∏è ${correo}</div>
                <div style="margin-top: 8px; line-height: 1.5;">üö® ${mensaje}</div>
                <button style="
                  float: right; background: #ecf0f1; border: none; border-radius: 50%; width: 24px; height: 24px;
                  font-size: 14px; cursor: pointer; color: #333; display: inline-flex; align-items: center; justify-content: center;
                ">&times;</button>
              `;

              alertDiv.querySelector('button').onclick = async () => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transition = 'opacity 0.3s';
                setTimeout(() => alertDiv.remove(), 300);
                await db.collection("alertas").doc(doc.id).delete();
              };

              alertsContainer.appendChild(alertDiv);
            }
          });

          if (!hasMatchingAlert) {
            alertsContainer.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 40px;">No tienes alertas asignadas.</p>';
          }
        }, (error) => {
          alertsContainer.innerHTML = `<p style="color: red; text-align: center;">‚ùå Error: ${error.message}</p>`;
        });
    };

    // === VERIFICAR SI YA EST√Å LOGUEADO ===
    const savedEmail = localStorage.getItem('currentUserEmail');
    if (savedEmail && AUTORIZED_EMAILS.includes(savedEmail)) {
      currentUserEmail = savedEmail;
      initApp();
    } else {
      showLoginModal();
    }
  };
})();
  </script>
</body>
</html>
